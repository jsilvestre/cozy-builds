// Generated by CoffeeScript 1.10.0
var Background, cozydb, fs, im;

cozydb = require('cozydb');

im = require('imagemagick');

fs = require('fs');

module.exports = Background = cozydb.getModel('Background', {
  binary: cozydb.NoSchema
});

Background.createNew = function(imagePath, callback) {
  return Background.create({}, function(err, background) {
    var fileOptions, filePath, id;
    id = background.id;
    filePath = '/tmp/home-background.jpg';
    fileOptions = {
      "with": 1920,
      height: 1200,
      srcPath: imagePath,
      dstPath: filePath,
      progressive: true
    };
    return im.resize(fileOptions, function(err, stdout, stderr) {
      var thumbOptions, thumbPath;
      if (err) {
        return callback(err);
      }
      thumbPath = '/tmp/home-thumb.jpg';
      thumbOptions = {
        "with": 300,
        height: 200,
        srcPath: imagePath,
        dstPath: thumbPath
      };
      return im.resize(thumbOptions, function(err, stdout, stderr) {
        var data;
        if (err) {
          return callback(err);
        }
        data = {
          name: 'file'
        };
        return Background.attachBinary(id, filePath, data, function(err) {
          if (err) {
            return callback(err);
          }
          data = {
            name: 'thumb'
          };
          return Background.attachBinary(id, thumbPath, data, function(err) {
            if (err) {
              return callback(err);
            }
            return fs.unlink(imagePath, function() {
              return fs.unlink(filePath, function() {
                return fs.unlink(thumbPath, function() {
                  return callback(null, background);
                });
              });
            });
          });
        });
      });
    });
  });
};
