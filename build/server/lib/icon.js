// Generated by CoffeeScript 1.10.0
var APPS_FOLDER, fs, icons, log, market, path;

fs = require('fs');

path = require('path');

log = require('printit')({
  prefix: 'icons'
});

module.exports = icons = {};

market = require('./market');

APPS_FOLDER = '/' + path.join('usr', 'local', 'cozy', 'apps');


/*
Get right icon path depending on app configuration:
* returns root folder + path mentioned in the manifest file if path is in the
  manifest.
* returns svg path if svg icon exists in the app folder.
* returns png path if png icon exists in the app folder.
* returns null otherwise
 */

icons.getPath = function(root, appli) {
  var basePath, extension, homeBasePath, iconPath, marketApp, pngPath, result, svgPath;
  marketApp = market.getApp(appli.slug);
  iconPath = null;
  if (marketApp != null) {
    homeBasePath = path.join(process.cwd(), 'client/app/assets');
    if (!fs.existsSync(homeBasePath)) {
      homeBasePath = path.join(process.cwd(), 'build/client/public');
    }
    iconPath = path.join(homeBasePath, marketApp.icon);
    if (!fs.existsSync(iconPath)) {
      iconPath = null;
    }
  } else if ((appli.iconPath != null) && fs.existsSync(path.join(root, appli.iconPath))) {
    iconPath = path.join(root, appli.iconPath);
  }
  if (iconPath == null) {
    basePath = path.join(root, "client", "app", "assets", "icons");
    svgPath = path.join(basePath, "main_icon.svg");
    pngPath = path.join(basePath, "main_icon.png");
    if (fs.existsSync(svgPath)) {
      iconPath = svgPath;
    } else if (fs.existsSync(pngPath)) {
      iconPath = pngPath;
    } else {
      iconPath = null;
    }
  }
  if (iconPath == null) {
    return null;
  } else {
    extension = iconPath.indexOf('.png') !== -1 ? 'png' : 'svg';
    result = {
      path: iconPath,
      extension: extension
    };
    return result;
  }
};

icons.getIconInfos = function(appli) {
  var iconInfos, name, newPath, oldPath, packageName, repoName, root, slug;
  name = appli.name.toLowerCase();
  slug = appli.slug || name;
  if (appli != null ? appli["package"] : void 0) {
    packageName = appli["package"].name || appli["package"];
    root = path.join(APPS_FOLDER, slug, 'node_modules', packageName);
  } else if (appli != null ? appli.git : void 0) {
    repoName = (appli.git.split('/')[4]).replace('.git', '');
    oldPath = path.join(APPS_FOLDER, name, name, repoName);
    newPath = path.join(APPS_FOLDER, slug);
    root = fs.existsSync(oldPath) ? oldPath : newPath;
  } else if (appli) {
    throw new Error('Appli has neither package nor git');
  } else {
    throw new Error('Appli cannot be reached');
  }
  iconInfos = icons.getPath(root, appli);
  if (iconInfos != null) {
    return iconInfos;
  } else {
    throw new Error("Icon not found");
  }
};

icons.save = function(appli, iconInfos, callback) {
  var iconStr, name;
  if (callback == null) {
    callback = function() {};
  }
  if (iconInfos != null) {
    iconStr = JSON.stringify(iconInfos);
    log.debug("Icon to save for app " + appli.slug + ": " + iconStr);
    name = "icon." + iconInfos.extension;
    return appli.attachFile(iconInfos.path, {
      name: name
    }, function(err) {
      if (err) {
        return callback(err);
      }
      return appli.updateAttributes({
        iconType: iconInfos.extension
      }, function(err) {
        return callback(err, iconInfos);
      });
    });
  } else {
    return callback(new Error('icon information not found'));
  }
};
