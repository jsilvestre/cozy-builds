// Generated by CoffeeScript 1.10.0
var AppManager, StackApplication, fs, localizationManager, log, request, sendError, slugify, spawn;

request = require("request-json");

fs = require('fs');

slugify = require('cozy-slug');

spawn = require('child_process').spawn;

log = require('printit')({
  prefix: "applications"
});

AppManager = require('../lib/paas').AppManager;

StackApplication = require('../models/stack_application');

localizationManager = require('../helpers/localization_manager');

sendError = function(res, err, code) {
  if (code == null) {
    code = 500;
  }
  if (err == null) {
    err = {
      stack: null,
      message: localizationManager.t("server error")
    };
  }
  console.log("Sending error to client:");
  console.log(err.stack);
  return res.status(code).send({
    error: true,
    success: false,
    message: err.message,
    stack: err.stack
  });
};

module.exports = {
  get: function(req, res, next) {
    return StackApplication.all(function(err, apps) {
      if (err) {
        return next(err);
      } else {
        return res.send({
          rows: apps
        });
      }
    });
  },
  update: function(req, res, next) {
    var manager;
    manager = new AppManager();
    return manager.updateStack(function(err, result) {
      if (err != null) {
        log.error(err);
        return sendError(res, err);
      } else {
        return res.send({
          success: true
        });
      }
    });
  },
  reboot: function(req, res, next) {
    var manager;
    manager = new AppManager();
    return manager.restartController(function(err, result) {
      if (err != null) {
        log.error(err);
        return sendError(res, err);
      } else {
        return res.send({
          success: true
        });
      }
    });
  }
};
