// Generated by CoffeeScript 1.10.0
var application, base, fs, urlHelper;

fs = require('fs');

urlHelper = require('cozy-url-sdk');

if ((base = process.env).NODE_ENV == null) {
  base.NODE_ENV = "development";
}

process.on('uncaughtException', function(err) {
  console.error(err.message);
  return console.error(err.stack);
});

application = module.exports = function(callback) {
  var americano, crtPath, errorMiddleware, initialize, keyPath, options;
  americano = require('americano');
  initialize = require('./server/initialize');
  errorMiddleware = require('./server/middlewares/errors');
  options = {
    name: 'proxy',
    port: process.env.PORT || urlHelper.proxy.port(),
    host: process.env.HOST || urlHelper.proxy.host(),
    root: __dirname
  };
  if (process.env.USE_SSL) {
    crtPath = process.env.SSL_CRT_PATH || '/etc/cozy/server.crt';
    keyPath = process.env.SSL_KEY_PATH || '/etc/cozy/server.key';
    options.tls = {
      cert: fs.readFileSync(crtPath),
      key: fs.readFileSync(keyPath)
    };
  }
  return americano.start(options, function(err, app, server) {
    app.use(errorMiddleware);
    return initialize(app, server, callback);
  });
};

if (!module.parent) {
  application();
}
